<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contractor PO System - Print Contractor Bill</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  </head>
  <body>
    <div class="app">
      <header class="app-header">
        <div class="brand">
          <div class="brand-logo">CP</div>
          <div class="brand-text">
            <h1>Contractor PO System</h1>
            <p>View and print contractor bills.</p>
          </div>
        </div>
        <a href="home.html" class="home-btn">Home</a>
      </header>

      <main class="app-main app-main--home">
        <section class="intro">
          <h2>Print Contractor Bill</h2>
          <p>Select a contractor and see their paid or unpaid bills.</p>
        </section>

        <!-- Filters -->
        <section class="panel">
          <div class="bill-filters">
            <div class="field field--inline">
              <label for="contractorFilter">Contractor Name</label>
              <select id="contractorFilter" required>
                <option value="">Select contractor</option>
              </select>
            </div>

            <div class="field field--inline">
              <label for="billStatusFilter">Bill Status</label>
              <select id="billStatusFilter">
                <option value="unpaid">Unpaid Bills</option>
                <option value="paid">Paid Bills</option>
              </select>
            </div>
          </div>
          <p class="inline-warning" id="billPageWarning"></p>
        </section>

        <!-- Bills Table -->
        <section class="panel">
          <header class="panel-header">
            <h3 id="billTableTitle">Unpaid Bills</h3>
          </header>
          <div class="panel-body">
            <div class="field" style="margin-bottom: 14px;">
              <label for="billNumberSearch">Search Bill Number</label>
              <input
                type="text"
                id="billNumberSearch"
                placeholder="Enter bill number to search..."
              />
            </div>
            <div class="table-wrapper">
              <table class="data-table" id="contractorBillsTable">
                <thead>
                  <!-- Filled by JS -->
                </thead>
                <tbody>
                  <!-- Rows filled by JS -->
                </tbody>
              </table>
            </div>
            <p class="inline-info" id="billTableInfo"></p>
          </div>
        </section>
      </main>

      <footer class="app-footer">
        <span>Contractor PO System</span>
        <span class="divider">‚Ä¢</span>
        <span>Print Contractor Bill</span>
      </footer>
    </div>

    <script type="module">
      import { contractorsAPI, billsAPI, billEditAPI } from './api.js';
      
      const API_BASE_URL = 'http://localhost:3000/api';

      const contractorSelect = document.getElementById('contractorFilter');
      const statusSelect = document.getElementById('billStatusFilter');
      const billNumberSearch = document.getElementById('billNumberSearch');
      const warningEl = document.getElementById('billPageWarning');
      const table = document.getElementById('contractorBillsTable');
      const tableHead = table.querySelector('thead');
      const tableBody = table.querySelector('tbody');
      const tableTitle = document.getElementById('billTableTitle');
      const tableInfo = document.getElementById('billTableInfo');
      let currentEditingBill = null;

      let allBills = [];

      function formatDate(dateStr) {
        if (!dateStr) return '-';
        const d = new Date(dateStr);
        if (Number.isNaN(d.getTime())) return '-';
        return d.toLocaleDateString();
      }

      function calculateBillTotal(bill) {
        if (!bill || !Array.isArray(bill.jobs)) return 0;
        const billAmount = bill.jobs.reduce((sumJobs, job) => {
          const jobTotal = (job.ops || []).reduce(
            (sumOps, op) => sumOps + (Number(op.totalValue) || 0),
            0
          );
          return sumJobs + jobTotal;
        }, 0);
        const roomRent = Number(bill.roomRent || 0);
        return billAmount + roomRent;
      }

      function calculateBillAmountOnly(bill) {
        if (!bill || !Array.isArray(bill.jobs)) return 0;
        return bill.jobs.reduce((sumJobs, job) => {
          const jobTotal = (job.ops || []).reduce(
            (sumOps, op) => sumOps + (Number(op.totalValue) || 0),
            0
          );
          return sumJobs + jobTotal;
        }, 0);
      }

      async function generateBillPDF(bill) {
        const { jsPDF } = window.jspdf;
        // Create PDF in landscape mode
        const doc = new jsPDF('landscape', 'mm', 'a4');
        
        // Page dimensions
        const pageWidth = doc.internal.pageSize.getWidth();  // ~297mm
        const pageHeight = doc.internal.pageSize.getHeight(); // ~210mm
        const margin = 15;
        const tableWidth = pageWidth - (2 * margin); // Full width table
        let yPos = margin;
        
        // ===== HEADER =====
        doc.setFontSize(22);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(40, 40, 40);
        doc.text('CONTRACTOR BILL', pageWidth / 2, yPos, { align: 'center' });
        yPos += 12;
        
        // Divider line under header
        doc.setDrawColor(79, 70, 229); // Accent color
        doc.setLineWidth(0.8);
        doc.line(margin, yPos, pageWidth - margin, yPos);
        yPos += 10;
        
        // Bill details row
        doc.setFontSize(11);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(60, 60, 60);
        const billDate = bill.createdAt ? new Date(bill.createdAt).toLocaleDateString() : '-';
        doc.text(`Bill No: ${bill.billNumber}`, margin, yPos);
        doc.text(`Date: ${billDate}`, pageWidth - margin, yPos, { align: 'right' });
        yPos += 7;
        
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(40, 40, 40);
        doc.text(`Contractor: ${bill.contractorName}`, margin, yPos);
        yPos += 12;
        
        // ===== TABLE SETUP =====
        const colHeaders = ['Job Number', 'Client Name', 'Job Title', 'Operation', 'Qty/Book', 'Rate', 'Qty Completed', 'Total Value'];
        // Distribute columns proportionally across full width
        const colRatios = [0.10, 0.12, 0.12, 0.22, 0.10, 0.10, 0.12, 0.12]; // Must sum to 1
        const colWidths = colRatios.map(r => r * tableWidth);
        const colX = [margin];
        for (let i = 1; i < colHeaders.length; i++) {
          colX.push(colX[i - 1] + colWidths[i - 1]);
        }
        const rowHeight = 9;
        
        // Function to draw table header
        function drawTableHeader(y) {
          // Header background
          doc.setFillColor(79, 70, 229); // Purple accent
          doc.rect(margin, y, tableWidth, rowHeight, 'F');
          
          // Header text
          doc.setFont(undefined, 'bold');
          doc.setFontSize(10);
          doc.setTextColor(255, 255, 255);
          
          colHeaders.forEach((header, i) => {
            const cellX = colX[i] + colWidths[i] / 2;
            doc.text(header, cellX, y + rowHeight - 2.5, { align: 'center' });
          });
          
          return y + rowHeight;
        }
        
        // Function to draw table row with text wrapping for Client Name, Job Title, and Operation
        function drawTableRow(y, values, isAlt) {
          doc.setFont(undefined, 'normal');
          doc.setFontSize(9);
          
          // Wrap text for Client Name (index 1), Job Title (index 2), and Operation (index 3)
          // Calculate available width for wrapping (column width minus padding)
          const padding = 6; // 3mm on each side
          const wrappedTexts = values.map((val, i) => {
            const text = String(val || '');
            // Only wrap Client Name (index 1), Job Title (index 2), and Operation (index 3)
            if (i === 1 || i === 2 || i === 3) {
              const availableWidth = colWidths[i] - padding;
              // Split text into multiple lines that fit within the column width
              const lines = doc.splitTextToSize(text, availableWidth);
              return lines;
            }
            return [text]; // Other columns: single line
          });
          
          // Calculate the maximum number of lines needed (for row height)
          const maxLines = Math.max(...wrappedTexts.map(lines => lines.length));
          const lineHeight = 4.5; // Height per line in mm
          const minRowHeight = 9; // Minimum row height
          const actualRowHeight = Math.max(minRowHeight, maxLines * lineHeight);
          
          // Row background
          if (isAlt) {
            doc.setFillColor(245, 245, 250);
            doc.rect(margin, y, tableWidth, actualRowHeight, 'F');
          }
          
          // Cell borders
          doc.setDrawColor(220, 220, 220);
          doc.setLineWidth(0.1);
          doc.line(margin, y + actualRowHeight, margin + tableWidth, y + actualRowHeight);
          
          // Vertical lines
          colX.forEach((x, i) => {
            if (i > 0) {
              doc.line(x, y, x, y + actualRowHeight);
            }
          });
          
          // Cell content
          doc.setTextColor(50, 50, 50);
          
          values.forEach((val, i) => {
            const lines = wrappedTexts[i];
            const cellX = i < 4 ? colX[i] + 3 : colX[i] + colWidths[i] - 3;
            const align = i < 4 ? 'left' : 'right';
            
            // Calculate starting Y position (center vertically if multiple lines)
            const totalTextHeight = lines.length * lineHeight;
            const startY = y + (actualRowHeight - totalTextHeight) / 2 + lineHeight;
            
            // Draw each line of text
            lines.forEach((line, lineIndex) => {
              const lineY = startY + (lineIndex * lineHeight);
              doc.text(line, cellX, lineY, { align: align });
            });
          });
          
          return y + actualRowHeight;
        }
        
        // Draw table header
        yPos = drawTableHeader(yPos);
        const tableStartY = yPos - rowHeight;
        let currentTableStartY = tableStartY;
        
        // Draw table rows
        let billAmount = 0;
        let rowCount = 0;
        
        bill.jobs.forEach((job) => {
          job.ops.forEach((op, opIndex) => {
            // Check for page break
            if (yPos > pageHeight - 50) {
              // Draw outer border for current page
              doc.setDrawColor(79, 70, 229);
              doc.setLineWidth(0.3);
              doc.rect(margin, currentTableStartY, tableWidth, yPos - currentTableStartY);
              
              doc.addPage('landscape');
              yPos = margin;
              yPos = drawTableHeader(yPos);
              currentTableStartY = yPos - rowHeight;
            }
            
            const qtyBook = Number(op.qtyBook || 0);
            const rate = Number(op.rate || 0);
            const qtyCompleted = Number(op.qtyCompleted || 0);
            const total = Number(op.totalValue || 0);
            billAmount += total;
            
            // Get operation name
            const operationName = op.opsName || op.operationName || op.name || `Op ${opIndex + 1}`;
            const jobNumberText = opIndex === 0 ? job.jobNumber : '';
            const clientNameText = opIndex === 0 ? (job.clientName || '') : '';
            const jobTitleText = opIndex === 0 ? (job.jobTitle || '') : '';
            
            const values = [
              jobNumberText,
              clientNameText,
              jobTitleText,
              operationName,
              qtyBook.toFixed(4),
              rate.toFixed(2),
              qtyCompleted.toFixed(2),
              total.toFixed(2)
            ];
            
            yPos = drawTableRow(yPos, values, rowCount % 2 === 1);
            rowCount++;
          });
        });
        
        // Draw outer border
        doc.setDrawColor(79, 70, 229);
        doc.setLineWidth(0.3);
        doc.rect(margin, currentTableStartY, tableWidth, yPos - currentTableStartY);
        
        // ===== GRAND TOTAL =====
        const roomRent = Number(bill.roomRent || 0);
        const grandTotal = billAmount + roomRent;
        
        yPos += 5;
        
        // If room rent exists, show breakdown
        if (roomRent > 0) {
          doc.setFont(undefined, 'normal');
          doc.setFontSize(10);
          doc.setTextColor(60, 60, 60);
          doc.text('Bill Amount:', pageWidth - margin - 100, yPos + 4, { align: 'right' });
          doc.text(billAmount.toFixed(2), pageWidth - margin - 3, yPos + 4, { align: 'right' });
          
          yPos += 6;
          doc.text('Room Rent:', pageWidth - margin - 100, yPos + 4, { align: 'right' });
          doc.text(roomRent.toFixed(2), pageWidth - margin - 3, yPos + 4, { align: 'right' });
          
          // Draw separator line below Room Rent (with more spacing)
          yPos += 6;
          doc.setDrawColor(200, 200, 200);
          doc.setLineWidth(0.2);
          doc.line(pageWidth - margin - 100, yPos, pageWidth - margin, yPos);
          yPos += 5;
        }
        
        doc.setFillColor(240, 240, 245);
        doc.rect(pageWidth - margin - 100, yPos, 100, 10, 'F');
        doc.setDrawColor(79, 70, 229);
        doc.setLineWidth(0.3);
        doc.rect(pageWidth - margin - 100, yPos, 100, 10);
        
        doc.setFont(undefined, 'bold');
        doc.setFontSize(11);
        doc.setTextColor(40, 40, 40);
        doc.text('Grand Total:', pageWidth - margin - 55, yPos + 7, { align: 'right' });
        doc.text(grandTotal.toFixed(2), pageWidth - margin - 3, yPos + 7, { align: 'right' });
        
        // ===== SIGNATURE LINE =====
        const sigY = pageHeight - 25;
        doc.setDrawColor(100, 100, 100);
        doc.setLineWidth(0.2);
        doc.line(pageWidth - margin - 70, sigY, pageWidth - margin, sigY);
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);
        doc.text('Authorized Signature', pageWidth - margin - 35, sigY + 5, { align: 'center' });
        
        // ===== FOOTER =====
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text('CDC Printers Pvt Ltd', pageWidth / 2, pageHeight - 5, { align: 'center' });
        
        // Save PDF
        doc.save(`Bill_${bill.billNumber}.pdf`);
      }

      async function downloadBill(billNumber) {
        try {
          const bill = await billsAPI.getByBillNumber(billNumber);
          // Debug: log bill structure to verify operation names
          console.log('Bill data received:', bill);
          if (bill.jobs && bill.jobs.length > 0) {
            console.log('First job operations:', bill.jobs[0].ops);
          }
          generateBillPDF(bill);
        } catch (error) {
          console.error('Error downloading bill:', error);
          warningEl.textContent = 'Error downloading bill. Please try again.';
          setTimeout(() => {
            warningEl.textContent = '';
          }, 3000);
        }
      }

      // ===== BILL EDITING (UNPAID ONLY, QTY COMPLETED ONLY) =====
      function openBillEditor(bill) {
        currentEditingBill = bill;

        const contractorId = contractorSelect.value;
        if (!contractorId) {
          alert('Please select a contractor first.');
          return;
        }

        // Remove any existing modal
        const existing = document.getElementById('bill-edit-modal');
        if (existing) {
          existing.remove();
        }

        // Create overlay
        const overlay = document.createElement('div');
        overlay.id = 'bill-edit-modal';
        overlay.style.position = 'fixed';
        overlay.style.inset = '0';
        overlay.style.backgroundColor = 'rgba(2, 6, 23, 0.85)';
        overlay.style.backdropFilter = 'blur(8px)';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.zIndex = '9999';

        // Modal container
        const modal = document.createElement('div');
        modal.style.backgroundColor = '#0b1020';
        modal.style.borderRadius = '18px';
        modal.style.boxShadow = '0 22px 50px rgba(15, 23, 42, 0.9)';
        modal.style.border = '1px solid rgba(156, 163, 175, 0.25)';
        modal.style.width = 'min(1000px, 95vw)';
        modal.style.maxHeight = '80vh';
        modal.style.display = 'flex';
        modal.style.flexDirection = 'column';
        modal.style.overflow = 'hidden';

        // Header
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.alignItems = 'center';
        header.style.justifyContent = 'space-between';
        header.style.padding = '14px 20px';
        header.style.borderBottom = '1px solid rgba(156, 163, 175, 0.25)';
        header.innerHTML = `
          <div>
            <h2 style="margin:0;font-size:16px;font-weight:600;color:#f9fafb;">
              Edit Bill ${bill.billNumber}
            </h2>
            <p style="margin:4px 0 0;font-size:12px;color:#9ca3af;">
              You can change completed quantities or delete operations/jobs for this unpaid bill.
            </p>
          </div>
          <button id="bill-edit-close-btn" style="
            border:none;
            background:transparent;
            font-size:18px;
            line-height:1;
            cursor:pointer;
            color:#9ca3af;
            transition:color 180ms ease-out;
          " title="Close" onmouseover="this.style.color='#f9fafb'" onmouseout="this.style.color='#9ca3af'">&times;</button>
        `;

        // Body with table
        const body = document.createElement('div');
        body.style.padding = '12px 20px 16px';
        body.style.overflow = 'auto';
        body.style.backgroundColor = '#0b1020';

        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.style.fontSize = '12px';
        table.style.color = '#f9fafb';

        table.innerHTML = `
          <thead>
            <tr style="background:#111833;">
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(156, 163, 175, 0.25);color:#f9fafb;">Job Number</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid rgba(156, 163, 175, 0.25);color:#f9fafb;">Operation</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid rgba(156, 163, 175, 0.25);color:#f9fafb;">Rate</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid rgba(156, 163, 175, 0.25);color:#f9fafb;">Completed Qty</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid rgba(156, 163, 175, 0.25);color:#f9fafb;">Total Value</th>
              <th style="text-align:center;padding:8px;border-bottom:1px solid rgba(156, 163, 175, 0.25);color:#f9fafb;">Delete</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');

        bill.jobs.forEach(job => {
          const jobNumber = job.jobNumber;
          (job.ops || []).forEach(op => {
            const opsName = op.opsName || '';
            const rate = Number(op.rate || 0);
            const oldQty = Number(op.qtyCompleted || 0);
            const totalValue = Number(op.totalValue || rate * oldQty || 0);

            const tr = document.createElement('tr');
            tr.dataset.jobNumber = jobNumber;
            tr.dataset.opsName = opsName;
            tr.dataset.rate = String(rate);
            tr.dataset.oldQty = String(oldQty);

            tr.innerHTML = `
              <td style="padding:6px 8px;border-bottom:1px solid rgba(156, 163, 175, 0.25);color:#f9fafb;">${jobNumber}</td>
              <td style="padding:6px 8px;border-bottom:1px solid rgba(156, 163, 175, 0.25);color:#f9fafb;">${opsName}</td>
              <td style="padding:6px 8px;border-bottom:1px solid rgba(156, 163, 175, 0.25);text-align:right;color:#f9fafb;">
                ${rate.toFixed(2)}
              </td>
              <td style="padding:6px 8px;border-bottom:1px solid rgba(156, 163, 175, 0.25);text-align:right;">
                <input
                  type="number"
                  min="0"
                  step="0.0001"
                  value="${oldQty}"
                  class="bill-edit-qty-input"
                  style="
                    width:90px;
                    padding:3px 6px;
                    font-size:12px;
                    text-align:right;
                    border:1px solid rgba(156, 163, 175, 0.25);
                    border-radius:4px;
                    background:#050816;
                    color:#f9fafb;
                    transition:border-color 180ms ease-out;
                  "
                  onfocus="this.style.borderColor='rgba(79, 70, 229, 0.6)'"
                  onblur="this.style.borderColor='rgba(156, 163, 175, 0.25)'"
                />
              </td>
              <td style="padding:6px 8px;border-bottom:1px solid rgba(156, 163, 175, 0.25);text-align:right;color:#f9fafb;">
                <span class="bill-edit-total-cell">${totalValue.toFixed(2)}</span>
              </td>
              <td style="padding:6px 8px;border-bottom:1px solid rgba(156, 163, 175, 0.25);text-align:center;">
                <button type="button" class="bill-edit-row-delete-btn" style="
                  border:1px solid rgba(239, 68, 68, 0.4);
                  background:rgba(239, 68, 68, 0.15);
                  color:#fca5a5;
                  font-size:11px;
                  padding:4px 8px;
                  border-radius:4px;
                  cursor:pointer;
                  transition:all 180ms ease-out;
                "
                onmouseover="this.style.background='rgba(239, 68, 68, 0.25)';this.style.borderColor='rgba(239, 68, 68, 0.6)'"
                onmouseout="this.style.background='rgba(239, 68, 68, 0.15)';this.style.borderColor='rgba(239, 68, 68, 0.4)'"
                >
                  Delete
                </button>
              </td>
            `;

            tbody.appendChild(tr);
          });
        });

        // Empty state
        if (!tbody.hasChildNodes()) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `
            <td colspan="6" style="padding:10px 8px;text-align:center;color:#9ca3af;font-size:12px;">
              This bill has no operations to edit.
            </td>
          `;
          tbody.appendChild(emptyRow);
        }

        // Live updates for totals & delete behaviour
        tbody.addEventListener('input', (e) => {
          const target = e.target;
          if (!(target instanceof HTMLInputElement)) return;
          if (!target.classList.contains('bill-edit-qty-input')) return;

          const tr = target.closest('tr');
          if (!tr) return;

          const rate = Number(tr.dataset.rate || 0);
          const newQty = Number(target.value || 0);
          const totalCell = tr.querySelector('.bill-edit-total-cell');
          if (totalCell) {
            const newTotal = rate * (Number.isFinite(newQty) ? newQty : 0);
            totalCell.textContent = newTotal.toFixed(2);
          }
        });

        tbody.addEventListener('click', (e) => {
          const target = e.target;
          if (!(target instanceof HTMLElement)) return;
          if (!target.classList.contains('bill-edit-row-delete-btn')) return;

          const tr = target.closest('tr');
          if (!tr) return;

          // Set qty to 0 to mark as deleted, keep row visible but greyed-out
          const input = tr.querySelector('.bill-edit-qty-input');
          if (input instanceof HTMLInputElement) {
            input.value = '0';
            input.dispatchEvent(new Event('input', { bubbles: true }));
          }
          tr.style.opacity = '0.4';
          tr.style.filter = 'grayscale(0.6)';
        });

        body.appendChild(table);

        // Footer with actions
        const footer = document.createElement('div');
        footer.style.display = 'flex';
        footer.style.justifyContent = 'space-between';
        footer.style.alignItems = 'center';
        footer.style.padding = '10px 20px 12px';
        footer.style.borderTop = '1px solid rgba(156, 163, 175, 0.25)';

        const note = document.createElement('div');
        note.style.fontSize = '11px';
        note.style.color = '#9ca3af';
        note.textContent = 'Note: Setting completed qty to 0 will delete that operation from the bill and restore its pending quantity.';

        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '8px';

        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.style.border = '1px solid rgba(156, 163, 175, 0.25)';
        cancelBtn.style.background = 'rgba(15, 23, 42, 0.6)';
        cancelBtn.style.borderRadius = '6px';
        cancelBtn.style.fontSize = '12px';
        cancelBtn.style.padding = '6px 12px';
        cancelBtn.style.cursor = 'pointer';
        cancelBtn.style.color = '#f9fafb';
        cancelBtn.style.transition = 'all 180ms ease-out';
        cancelBtn.onmouseover = () => {
          cancelBtn.style.background = 'rgba(79, 70, 229, 0.3)';
          cancelBtn.style.borderColor = 'rgba(129, 140, 248, 0.8)';
        };
        cancelBtn.onmouseout = () => {
          cancelBtn.style.background = 'rgba(15, 23, 42, 0.6)';
          cancelBtn.style.borderColor = 'rgba(156, 163, 175, 0.25)';
        };

        const saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.textContent = 'Save Changes';
        saveBtn.style.border = 'none';
        saveBtn.style.background = '#4f46e5';
        saveBtn.style.borderRadius = '6px';
        saveBtn.style.fontSize = '12px';
        saveBtn.style.padding = '6px 14px';
        saveBtn.style.cursor = 'pointer';
        saveBtn.style.color = '#ffffff';
        saveBtn.style.transition = 'all 180ms ease-out';
        saveBtn.onmouseover = () => {
          saveBtn.style.background = 'rgba(99, 102, 241, 1)';
          saveBtn.style.transform = 'translateY(-1px)';
        };
        saveBtn.onmouseout = () => {
          saveBtn.style.background = '#4f46e5';
          saveBtn.style.transform = 'translateY(0)';
        };

        actions.appendChild(cancelBtn);
        actions.appendChild(saveBtn);

        footer.appendChild(note);
        footer.appendChild(actions);

        modal.appendChild(header);
        modal.appendChild(body);
        modal.appendChild(footer);

        overlay.appendChild(modal);
        document.body.appendChild(overlay);

        // Add CSS to hide spinner arrows on number inputs
        const style = document.createElement('style');
        style.textContent = `
          #bill-edit-modal input[type="number"]::-webkit-inner-spin-button,
          #bill-edit-modal input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
          }
          #bill-edit-modal input[type="number"] {
            -moz-appearance: textfield;
          }
        `;
        overlay.appendChild(style);

        // Close handlers
        const closeBtn = header.querySelector('#bill-edit-close-btn');
        const closeModal = () => {
          overlay.remove();
          currentEditingBill = null;
        };
        if (closeBtn) {
          closeBtn.addEventListener('click', closeModal);
        }
        cancelBtn.addEventListener('click', closeModal);
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            closeModal();
          }
        });

        // Save handler
        saveBtn.addEventListener('click', () => {
          const rows = Array.from(tbody.querySelectorAll('tr'));
          const changes = [];

          rows.forEach(tr => {
            const jobNumber = tr.dataset.jobNumber;
            const opsName = tr.dataset.opsName;
            const rateStr = tr.dataset.rate;
            const oldQtyStr = tr.dataset.oldQty;

            if (!jobNumber || !opsName || rateStr === undefined || oldQtyStr === undefined) {
              return;
            }

            const input = tr.querySelector('.bill-edit-qty-input');
            if (!(input instanceof HTMLInputElement)) return;

            const rate = Number(rateStr || 0);
            const oldQty = Number(oldQtyStr || 0);
            const newQty = Number(input.value || 0);

            if (!Number.isFinite(newQty) || newQty < 0) {
              return;
            }

            if (newQty !== oldQty) {
              changes.push({
                jobNumber,
                opsName,
                rate,
                newQtyCompleted: newQty
              });
            }
          });

          if (changes.length === 0) {
            alert('No changes to save.');
            return;
          }

          billEditAPI.editQuantities(bill.billNumber, contractorId, changes)
            .then(() => {
              alert('Bill updated successfully.');
              closeModal();
              loadBills();
            })
            .catch((error) => {
              console.error('Error editing bill quantities:', error);
              alert(error.message || 'Error editing bill. Please try again.');
            });
        });
      }

      async function markBillAsPaid(billNumber) {
        try {
          // Get the bill to find contractor name
          const bill = await billsAPI.getByBillNumber(billNumber);
          const contractorName = bill.contractorName;
          
          // Check if contractor has paid bill with roomRent in last 30 days
          const roomRentCheck = await billsAPI.checkRoomRent(contractorName);
          let roomRent = 0;
          
          if (!roomRentCheck.hasRoomRent) {
            // Show custom modal to add room rent with Skip option
            const roomRentValue = await showRoomRentModal(contractorName);
            
            if (roomRentValue === null) {
              // User cancelled
              return;
            }
            
            roomRent = roomRentValue;
          }
          
          // Mark bill as paid with room rent
          await billsAPI.markAsPaid(billNumber, roomRent);
          
          // Reload bills to refresh the table
          await loadBills();
          warningEl.textContent = 'Bill marked as paid successfully!';
          warningEl.style.color = '#4ade80';
          setTimeout(() => {
            warningEl.textContent = '';
            warningEl.style.color = '';
          }, 3000);
        } catch (error) {
          console.error('Error marking bill as paid:', error);
          warningEl.textContent = error.message || 'Error marking bill as paid. Please try again.';
          setTimeout(() => {
            warningEl.textContent = '';
          }, 3000);
        }
      }

      function showRoomRentModal(contractorName) {
        return new Promise((resolve) => {
          // Remove any existing modal
          const existing = document.getElementById('room-rent-modal');
          if (existing) {
            existing.remove();
          }

          // Create overlay
          const overlay = document.createElement('div');
          overlay.id = 'room-rent-modal';
          overlay.style.position = 'fixed';
          overlay.style.inset = '0';
          overlay.style.backgroundColor = 'rgba(2, 6, 23, 0.85)';
          overlay.style.backdropFilter = 'blur(8px)';
          overlay.style.display = 'flex';
          overlay.style.alignItems = 'center';
          overlay.style.justifyContent = 'center';
          overlay.style.zIndex = '10000';

          // Modal container
          const modal = document.createElement('div');
          modal.style.backgroundColor = '#0b1020';
          modal.style.borderRadius = '18px';
          modal.style.boxShadow = '0 22px 50px rgba(15, 23, 42, 0.9)';
          modal.style.border = '1px solid rgba(156, 163, 175, 0.25)';
          modal.style.width = 'min(400px, 90vw)';
          modal.style.padding = '24px';
          modal.style.display = 'flex';
          modal.style.flexDirection = 'column';
          modal.style.gap = '16px';

          // Header
          const header = document.createElement('div');
          header.innerHTML = `
            <h2 style="margin:0;font-size:18px;font-weight:600;color:#f9fafb;">
              Add Room Rent
            </h2>
            <p style="margin:8px 0 0;font-size:13px;color:#9ca3af;">
              No room rent found for <strong style="color:#f9fafb;">${contractorName}</strong> in the last 30 days.
            </p>
          `;

          // Input field
          const inputContainer = document.createElement('div');
          inputContainer.style.display = 'flex';
          inputContainer.style.flexDirection = 'column';
          inputContainer.style.gap = '8px';

          const label = document.createElement('label');
          label.textContent = 'Room Rent Amount:';
          label.style.fontSize = '13px';
          label.style.color = '#f9fafb';
          label.style.fontWeight = '500';

          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.step = '0.01';
          input.value = '0';
          input.style.width = '100%';
          input.style.padding = '10px 12px';
          input.style.fontSize = '14px';
          input.style.border = '1px solid rgba(156, 163, 175, 0.25)';
          input.style.borderRadius = '8px';
          input.style.background = '#050816';
          input.style.color = '#f9fafb';
          input.style.transition = 'border-color 180ms ease-out';
          input.onfocus = () => {
            input.style.borderColor = 'rgba(79, 70, 229, 0.6)';
          };
          input.onblur = () => {
            input.style.borderColor = 'rgba(156, 163, 175, 0.25)';
          };

          // Hide spinner arrows
          const style = document.createElement('style');
          style.textContent = `
            #room-rent-modal input[type="number"]::-webkit-inner-spin-button,
            #room-rent-modal input[type="number"]::-webkit-outer-spin-button {
              -webkit-appearance: none;
              margin: 0;
            }
            #room-rent-modal input[type="number"] {
              -moz-appearance: textfield;
            }
          `;
          overlay.appendChild(style);

          inputContainer.appendChild(label);
          inputContainer.appendChild(input);

          // Buttons
          const buttons = document.createElement('div');
          buttons.style.display = 'flex';
          buttons.style.gap = '10px';
          buttons.style.justifyContent = 'flex-end';
          buttons.style.marginTop = '8px';

          const skipBtn = document.createElement('button');
          skipBtn.type = 'button';
          skipBtn.textContent = 'Skip';
          skipBtn.style.border = '1px solid rgba(156, 163, 175, 0.25)';
          skipBtn.style.background = 'rgba(15, 23, 42, 0.6)';
          skipBtn.style.borderRadius = '8px';
          skipBtn.style.fontSize = '13px';
          skipBtn.style.padding = '8px 16px';
          skipBtn.style.cursor = 'pointer';
          skipBtn.style.color = '#f9fafb';
          skipBtn.style.transition = 'all 180ms ease-out';
          skipBtn.onmouseover = () => {
            skipBtn.style.background = 'rgba(79, 70, 229, 0.3)';
            skipBtn.style.borderColor = 'rgba(129, 140, 248, 0.8)';
          };
          skipBtn.onmouseout = () => {
            skipBtn.style.background = 'rgba(15, 23, 42, 0.6)';
            skipBtn.style.borderColor = 'rgba(156, 163, 175, 0.25)';
          };

          const cancelBtn = document.createElement('button');
          cancelBtn.type = 'button';
          cancelBtn.textContent = 'Cancel';
          cancelBtn.style.border = '1px solid rgba(156, 163, 175, 0.25)';
          cancelBtn.style.background = 'rgba(15, 23, 42, 0.6)';
          cancelBtn.style.borderRadius = '8px';
          cancelBtn.style.fontSize = '13px';
          cancelBtn.style.padding = '8px 16px';
          cancelBtn.style.cursor = 'pointer';
          cancelBtn.style.color = '#f9fafb';
          cancelBtn.style.transition = 'all 180ms ease-out';
          cancelBtn.onmouseover = () => {
            cancelBtn.style.background = 'rgba(79, 70, 229, 0.3)';
            cancelBtn.style.borderColor = 'rgba(129, 140, 248, 0.8)';
          };
          cancelBtn.onmouseout = () => {
            cancelBtn.style.background = 'rgba(15, 23, 42, 0.6)';
            cancelBtn.style.borderColor = 'rgba(156, 163, 175, 0.25)';
          };

          const okBtn = document.createElement('button');
          okBtn.type = 'button';
          okBtn.textContent = 'OK';
          okBtn.style.border = 'none';
          okBtn.style.background = '#4f46e5';
          okBtn.style.borderRadius = '8px';
          okBtn.style.fontSize = '13px';
          okBtn.style.padding = '8px 20px';
          okBtn.style.cursor = 'pointer';
          okBtn.style.color = '#ffffff';
          okBtn.style.transition = 'all 180ms ease-out';
          okBtn.onmouseover = () => {
            okBtn.style.background = 'rgba(99, 102, 241, 1)';
            okBtn.style.transform = 'translateY(-1px)';
          };
          okBtn.onmouseout = () => {
            okBtn.style.background = '#4f46e5';
            okBtn.style.transform = 'translateY(0)';
          };

          const closeModal = () => {
            overlay.remove();
          };

          skipBtn.addEventListener('click', () => {
            resolve(0); // Skip = 0 room rent
            closeModal();
          });

          cancelBtn.addEventListener('click', () => {
            resolve(null); // Cancel = null (abort payment)
            closeModal();
          });

          okBtn.addEventListener('click', () => {
            const rentValue = Number(input.value);
            if (isNaN(rentValue) || rentValue < 0) {
              alert('Invalid room rent amount. Please enter a non-negative number.');
              input.focus();
              return;
            }
            resolve(rentValue);
            closeModal();
          });

          // Enter key on input
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              okBtn.click();
            }
          });

          buttons.appendChild(skipBtn);
          buttons.appendChild(cancelBtn);
          buttons.appendChild(okBtn);

          modal.appendChild(header);
          modal.appendChild(inputContainer);
          modal.appendChild(buttons);

          overlay.appendChild(modal);
          document.body.appendChild(overlay);

          // Focus input
          setTimeout(() => input.focus(), 100);

          // Close on overlay click
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              resolve(null);
              closeModal();
            }
          });
        });
      }

      async function deleteBill(billNumber) {
        try {
          await billsAPI.delete(billNumber);
          // Reload bills to refresh the table
          await loadBills();
          warningEl.textContent = 'Bill deleted successfully! Pending quantities have been restored.';
          warningEl.style.color = '#4ade80';
          setTimeout(() => {
            warningEl.textContent = '';
            warningEl.style.color = '';
          }, 3000);
        } catch (error) {
          console.error('Error deleting bill:', error);
          warningEl.textContent = error.message || 'Error deleting bill. Please try again.';
          warningEl.style.color = '#ef4444';
          setTimeout(() => {
            warningEl.textContent = '';
            warningEl.style.color = '';
          }, 3000);
        }
      }

      function renderTable() {
        const contractorName =
          contractorSelect.options[contractorSelect.selectedIndex]?.textContent || '';
        const status = statusSelect.value; // 'paid' | 'unpaid'
        const searchTerm = (billNumberSearch.value || '').trim().toLowerCase();

        tableBody.innerHTML = '';
        tableHead.innerHTML = '';
        warningEl.textContent = '';
        tableInfo.textContent = '';

        if (!contractorSelect.value) {
          tableInfo.textContent = 'Please select a contractor to view bills.';
          return;
        }

        const isPaid = status === 'paid';
        tableTitle.textContent = isPaid ? 'Paid Bills' : 'Unpaid Bills';

        let filtered = allBills.filter((bill) => {
          if (bill.contractorName !== contractorName) return false;
          const paid = bill.paymentStatus === 'Yes';
          
          // Filter by payment status
          if (isPaid && !paid) return false;
          if (!isPaid && paid) return false;

          // Filter by bill number search
          if (searchTerm) {
            const billNum = (bill.billNumber || '').toLowerCase();
            if (!billNum.includes(searchTerm)) return false;
          }

          return true;
        });

        // Sort unpaid bills by creation date (oldest first)
        if (!isPaid) {
          filtered.sort((a, b) => {
            const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
            const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
            return dateA - dateB; // Ascending order (oldest first)
          });
        }

        if (filtered.length === 0) {
          tableHead.innerHTML = '';
          const colspan = isPaid ? 5 : 7; // Paid: 5 columns, Unpaid: 7 columns (includes Edit)
          tableBody.innerHTML =
            `<tr><td colspan="${colspan}">No ` +
            (isPaid ? 'paid' : 'unpaid') +
            ' bills found for this contractor.</td></tr>';
          return;
        }

        if (isPaid) {
          tableHead.innerHTML = `
            <tr>
              <th>Bill Number</th>
              <th>Paid Date</th>
              <th>Total Amount</th>
              <th>Download</th>
              <th>Delete</th>
            </tr>
          `;
        } else {
          tableHead.innerHTML = `
            <tr>
              <th>Bill Number</th>
              <th>Creation Date</th>
              <th>Total Amount</th>
              <th>Download</th>
              <th>Edit</th>
              <th>Pay</th>
              <th>Delete</th>
            </tr>
          `;
        }

        let grandTotal = 0;

        filtered.forEach((bill) => {
          const billAmount = calculateBillAmountOnly(bill);
          const roomRent = Number(bill.roomRent || 0);
          const total = calculateBillTotal(bill);
          grandTotal += total;

          const tr = document.createElement('tr');

          // Format total amount display: show breakdown if room rent exists
          let totalDisplay = total.toFixed(2);
          if (roomRent > 0) {
            totalDisplay = `${billAmount.toFixed(2)} + ${roomRent.toFixed(2)} = ${total.toFixed(2)}`;
          }

          if (isPaid) {
            tr.innerHTML = `
              <td>${bill.billNumber}</td>
              <td>${formatDate(bill.paymentDate)}</td>
              <td title="${roomRent > 0 ? `Bill: ${billAmount.toFixed(2)}, Room Rent: ${roomRent.toFixed(2)}` : ''}">${totalDisplay}</td>
              <td>
                <button class="secondary-btn primary-btn--sm bill-download-btn" data-bill="${bill.billNumber}">
                  Download
                </button>
              </td>
              <td>
                <button class="secondary-btn primary-btn--sm bill-delete-btn" data-bill="${bill.billNumber}" title="Delete Bill">
                  üóëÔ∏è
                </button>
              </td>
            `;
          } else {
            tr.innerHTML = `
              <td>${bill.billNumber}</td>
              <td>${formatDate(bill.createdAt)}</td>
              <td>${totalDisplay}</td>
              <td>
                <button class="secondary-btn primary-btn--sm bill-download-btn" data-bill="${bill.billNumber}">
                  Download
                </button>
              </td>
              <td>
                <button class="secondary-btn primary-btn--sm bill-edit-btn" data-bill="${bill.billNumber}">
                  Edit
                </button>
              </td>
              <td>
                <button class="primary-btn primary-btn--sm bill-pay-btn" data-bill="${bill.billNumber}">
                  Pay
                </button>
              </td>
              <td>
                <button class="secondary-btn primary-btn--sm bill-delete-btn" data-bill="${bill.billNumber}" title="Delete Bill">
                  üóëÔ∏è
                </button>
              </td>
            `;
          }

          tableBody.appendChild(tr);
        });

        tableInfo.textContent = `Showing ${filtered.length} ${
          isPaid ? 'paid' : 'unpaid'
        } bill(s). Grand total: ${grandTotal.toFixed(2)}`;
      }

      async function loadContractors() {
        try {
          const contractors = await contractorsAPI.getAll();
          contractorSelect.innerHTML = '<option value="">Select contractor</option>';
          contractors.forEach((c) => {
            const opt = document.createElement('option');
            // Keep contractorId as value, show readable name
            opt.value = c.contractorId || c._id || c.name;
            opt.textContent = c.name;
            contractorSelect.appendChild(opt);
          });
        } catch (err) {
          console.error('Error loading contractors', err);
          warningEl.textContent = 'Error loading contractors. Please refresh the page.';
        }
      }

      async function loadBills() {
        try {
          allBills = await billsAPI.getAll();
          renderTable();
        } catch (err) {
          console.error('Error loading bills', err);
          warningEl.textContent = 'Error loading bills. Please refresh the page.';
        }
      }

      contractorSelect.addEventListener('change', () => {
        renderTable();
      });

      statusSelect.addEventListener('change', () => {
        renderTable();
      });

      billNumberSearch.addEventListener('input', () => {
        renderTable();
      });

      tableBody.addEventListener('click', async (e) => {
        const target = e.target;
        if (!(target instanceof HTMLElement)) return;

        if (target.classList.contains('bill-download-btn')) {
          const billNumber = target.getAttribute('data-bill');
          if (billNumber) {
            await downloadBill(billNumber);
          }
        } else if (target.classList.contains('bill-edit-btn')) {
          const billNumber = target.getAttribute('data-bill');
          if (billNumber) {
            try {
              const bill = await billsAPI.getByBillNumber(billNumber);
              openBillEditor(bill);
            } catch (error) {
              console.error('Error loading bill for edit:', error);
              alert('Error loading bill for editing. Please try again.');
            }
          }
        } else if (target.classList.contains('bill-pay-btn')) {
          const billNumber = target.getAttribute('data-bill');
          if (billNumber) {
            if (confirm(`Are you sure you want to mark bill ${billNumber} as paid?`)) {
              await markBillAsPaid(billNumber);
            }
          }
        } else if (target.classList.contains('bill-delete-btn')) {
          const billNumber = target.getAttribute('data-bill');
          if (billNumber) {
            if (confirm(`Are you sure you want to delete bill ${billNumber}? This will restore pending quantities and update completed quantities in the database. This action cannot be undone.`)) {
              await deleteBill(billNumber);
            }
          }
        }
      });

      // Initial load
      loadContractors();
      loadBills();
    </script>
  </body>
</html>

